<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
      @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
      .fade-in { animation: fadeIn 0.3s ease-in; }
      .custom-scrollbar::-webkit-scrollbar { height: 10px; width: 10px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 10px; }
      .file-upload-area { border: 2px dashed #cbd5e1; transition: all 0.3s ease; }
      .file-upload-area.dragover { border-color: #4f46e5; background-color: #eef2ff; }
    </style>
  </head>

  <body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    
    <div id="loginOverlay" class="fixed inset-0 bg-indigo-900 bg-opacity-90 z-[100] flex items-center justify-center">
        <div class="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-sm w-full mx-4">
            <h1 class="text-3xl font-bold text-indigo-900 mb-2">Portal Access</h1>
            <p class="text-gray-500 mb-8 text-sm">Sign in with your organizational Google account to continue.</p>
            
            <div id="g_id_onload"
                 data-client_id="6028770914-4g3l4amo8n2iehj5qmn9tg8ag7hh6cp8.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin flex justify-center" data-type="standard" data-shape="pill" data-theme="filled_blue" data-text="signin_with" data-size="large" data-logo_alignment="left"></div>
        </div>
    </div>

    <div id="appContent" class="hidden">
        <header class="bg-white shadow-lg sticky top-0 z-50">
          <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div>
              <h1 class="text-2xl font-bold text-indigo-900">Document Management System</h1>
            </div>
            <div class="flex items-center gap-4">
                <span id="userDisplay" class="text-sm font-medium text-gray-700"></span>
                <button onclick="logout()" class="text-red-600 hover:text-red-800 text-xs font-bold uppercase tracking-wider">Logout</button>
            </div>
          </div>
        </header>

        <main class="max-w-6xl mx-auto px-4 py-8">
          <div id="successMessage" class="hidden bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-lg mb-6 shadow-md fade-in">
              <p class="font-semibold">Success!</p>
              <p class="text-sm" id="successDocketNo"></p>
          </div>

          <div class="bg-white rounded-xl shadow-xl p-8 mb-8 border border-indigo-100">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 pb-4 border-b-2 border-indigo-500 flex items-center">
              Register Document
            </h2>

            <form id="documentForm" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-indigo-50 p-6 rounded-lg border border-indigo-200 shadow-inner">
                  <div>
                    <label class="block text-xs font-bold text-indigo-700 uppercase mb-2">Docket Number (Preview)</label>
                    <input type="text" id="docketPreview" readonly class="w-full px-4 py-2 bg-white border-2 border-indigo-200 rounded text-lg font-mono text-indigo-900 cursor-not-allowed" value="Generating..." />
                  </div>
                  <div>
                    <label class="block text-xs font-bold text-indigo-700 uppercase mb-2">System Date</label>
                    <input type="text" id="systemDate" readonly class="w-full px-4 py-2 bg-white border-2 border-indigo-200 rounded text-gray-500 cursor-not-allowed" />
                  </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Category *</label>
                    <select id="documentCategory" name="document_category" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 outline-none">
                      <option value="OFFICIAL_COMMUNICATION">Official Communication</option>
                      <option value="NOTE">Note</option>
                      <option value="ESTIMATE">Estimate</option>
                      <option value="OTHERS">Others</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Communication Type *</label>
                    <select id="communicationCategory" name="communication_category" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 outline-none">
                      <option value="ONLINE">Online</option>
                      <option value="HARD_COPY">Hard Copy</option>
                    </select>
                  </div>
                  <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Document Title *</label>
                    <input type="text" id="documentTitle" name="document_title" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg" placeholder="Subject of the document">
                  </div>
              </div>

              <div class="bg-blue-50 p-6 rounded-lg border-2 border-blue-200">
                <div class="file-upload-area rounded-lg p-8 text-center cursor-pointer bg-white" id="fileUploadArea">
                  <p class="text-gray-600 mb-2"><span class="font-bold text-indigo-600">Click to upload files</span> or drag and drop</p>
                  <input type="file" id="fileInput" multiple class="hidden" />
                </div>
                <div id="fileList" class="mt-4 space-y-2"></div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6 bg-gray-50 rounded-lg border border-gray-200">
                  <input type="text" id="originatingDept" name="originating_dept" required placeholder="Originating Dept" class="w-full px-4 py-3 border rounded-lg">
                  <input type="text" id="receivedFrom" name="received_from" required placeholder="Received From" class="w-full px-4 py-3 border rounded-lg">
              </div>

              <div class="flex justify-center">
                <button type="submit" id="submitBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-16 rounded-xl shadow-lg transition-all transform hover:scale-105 active:scale-95">
                  Register Document
                </button>
              </div>
            </form>
          </div>

          <div class="bg-white rounded-xl shadow-xl p-8 mb-8 border border-indigo-100">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold text-gray-800">Recent Records (<span id="docCount">0</span>)</h2>
              <button onclick="loadDocuments()" class="text-indigo-600 font-semibold hover:underline">Refresh List</button>
            </div>

            <div class="overflow-x-auto custom-scrollbar">
              <div class="min-w-[1200px]">
                <table class="w-full text-sm">
                  <thead class="bg-indigo-50 border-b-2 border-indigo-100">
                    <tr class="text-left text-indigo-900 font-bold uppercase tracking-wider text-xs">
                      <th class="px-4 py-3">Docket No</th>
                      <th class="px-4 py-3">Date</th>
                      <th class="px-4 py-3">Title</th>
                      <th class="px-4 py-3">Category</th>
                      <th class="px-4 py-3">From</th>
                      <th class="px-4 py-3">Status/To</th>
                      <th class="px-4 py-3">Files</th>
                      <th class="px-4 py-3">Action</th>
                    </tr>
                  </thead>
                  <tbody id="documentsTableBody" class="divide-y divide-gray-100">
                    </tbody>
                </table>
              </div>
            </div>
          </div>
        </main>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[200]">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96">
            <h3 class="text-xl font-bold mb-4">Update Outward Status</h3>
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editDocketNo">
                <input type="text" id="editDestination" placeholder="Destination Department" required class="w-full p-3 border rounded">
                <input type="datetime-local" id="editOutwardDate" required class="w-full p-3 border rounded">
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded font-bold">Save</button>
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-200 py-2 rounded font-bold">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
      const API_URL = "http://127.0.0.1:8000";
      let userToken = localStorage.getItem("google_token");
      let uploadedFiles = [];

      // --- AUTH LOGIC ---
      function handleCredentialResponse(response) {
          userToken = response.credential;
          localStorage.setItem("google_token", userToken);
          
          const payload = JSON.parse(atob(userToken.split('.')[1]));
          document.getElementById("userDisplay").innerText = payload.email;
          
          document.getElementById("loginOverlay").classList.add("hidden");
          document.getElementById("appContent").classList.remove("hidden");
          
          initApp();
      }

      function logout() {
          localStorage.removeItem("google_token");
          location.reload();
      }

      // Check login on load
      if (userToken) {
          // Verify if token is expired in a real app, here we just show
          const payload = JSON.parse(atob(userToken.split('.')[1]));
          document.getElementById("userDisplay").innerText = payload.email;
          document.getElementById("loginOverlay").classList.add("hidden");
          document.getElementById("appContent").classList.remove("hidden");
          initApp();
      }

      function initApp() {
          document.getElementById("systemDate").value = new Date().toLocaleString();
          setupFileUpload();
          loadDocuments();
      }

      // --- FILE LOGIC ---
      function setupFileUpload() {
          const area = document.getElementById("fileUploadArea");
          const input = document.getElementById("fileInput");
          area.addEventListener("click", () => input.click());
          input.addEventListener("change", (e) => handleFiles(e.target.files));
          area.addEventListener("dragover", (e) => { e.preventDefault(); area.classList.add("dragover"); });
          area.addEventListener("drop", (e) => { e.preventDefault(); area.classList.remove("dragover"); handleFiles(e.dataTransfer.files); });
      }

      function handleFiles(files) {
          Array.from(files).forEach(f => {
              uploadedFiles.push(f);
              const div = document.createElement("div");
              div.className = "flex justify-between items-center bg-white p-2 border rounded";
              div.innerHTML = `<span>${f.name}</span><button onclick="this.parentElement.remove()" class="text-red-500">âœ–</button>`;
              document.getElementById("fileList").appendChild(div);
          });
      }

      // --- DATA LOGIC ---
      async function loadDocuments() {
          const tbody = document.getElementById("documentsTableBody");
          try {
              const res = await fetch(`${API_URL}/documents`, {
                  headers: { "x-google-token": userToken }
              });
              if (res.status === 401) logout();
              const docs = await res.json();
              document.getElementById("docCount").innerText = docs.length;
              
              tbody.innerHTML = docs.map(doc => `
                <tr class="hover:bg-gray-50 transition">
                  <td class="px-4 py-4 font-mono font-bold text-indigo-900">${doc.docketNo}</td>
                  <td class="px-4 py-4 text-xs">${new Date(doc.receivingDateTime).toLocaleDateString()}</td>
                  <td class="px-4 py-4 font-medium">${doc.documentTitle}</td>
                  <td class="px-4 py-4">${doc.documentCategory}</td>
                  <td class="px-4 py-4">${doc.receivedFrom}</td>
                  <td class="px-4 py-4">
                      ${doc.destinationDept ? `<span class="text-green-600 font-bold">${doc.destinationDept}</span>` : `<span class="text-amber-500 font-bold italic">Pending</span>`}
                  </td>
                  <td class="px-4 py-4">
                      ${doc.files.map(f => `<a href="${f.link}" target="_blank" class="text-blue-600 text-xs block truncate max-w-[100px] hover:underline">ðŸ“Ž ${f.name}</a>`).join('')}
                  </td>
                  <td class="px-4 py-4">
                      <button onclick="openEditModal('${doc.docketNo}', '${doc.destinationDept || ''}', '${doc.outwardDateTime || ''}')" class="text-indigo-600 hover:text-indigo-900 font-bold">Update</button>
                  </td>
                </tr>
              `).join('');
          } catch (e) { console.error(e); }
      }

      document.getElementById("documentForm").addEventListener("submit", async (e) => {
          e.preventDefault();
          const btn = document.getElementById("submitBtn");
          btn.disabled = true; btn.innerText = "Processing...";

          const formData = new FormData(e.target);
          uploadedFiles.forEach(f => formData.append("files", f));

          try {
              const res = await fetch(`${API_URL}/register`, {
                  method: "POST",
                  headers: { "x-google-token": userToken },
                  body: formData
              });
              const data = await res.json();
              if (res.ok) {
                  document.getElementById("successDocketNo").innerText = "DOCKET: " + data.docket_no;
                  document.getElementById("successMessage").classList.remove("hidden");
                  e.target.reset();
                  document.getElementById("fileList").innerHTML = "";
                  uploadedFiles = [];
                  loadDocuments();
                  window.scrollTo(0, 0);
              }
          } catch (err) { alert("Registration Error"); }
          finally { btn.disabled = false; btn.innerText = "Register Document"; }
      });

      // --- EDIT LOGIC ---
      function openEditModal(docket, dest, date) {
          document.getElementById("editModal").classList.remove("hidden");
          document.getElementById("editDocketNo").value = docket;
          document.getElementById("editDestination").value = dest;
          document.getElementById("editOutwardDate").value = date;
      }
      function closeModal() { document.getElementById("editModal").classList.add("hidden"); }

      document.getElementById("editForm").addEventListener("submit", async (e) => {
          e.preventDefault();
          const payload = {
              docket_no: document.getElementById("editDocketNo").value,
              destination_dept: document.getElementById("editDestination").value,
              outward_date_time: document.getElementById("editOutwardDate").value
          };
          try {
              await fetch(`${API_URL}/update_movement`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json", "x-google-token": userToken },
                  body: JSON.stringify(payload)
              });
              closeModal();
              loadDocuments();
          } catch (e) { alert("Update failed"); }
      });
    </script>
  </body>
</html>